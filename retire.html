<script>
  document.getElementById("retireForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const age = +document.getElementById("age").value;
    const retireAge = +document.getElementById("retireAge").value;
    const lifeExpect = +document.getElementById("lifeExpect").value;
    const monthlySaving = +document.getElementById("monthlySaving").value;
    const annualReturn = +document.getElementById("annualReturn").value;
    const monthlyExpense = +document.getElementById("monthlyExpense").value;

    const yearsToSave = retireAge - age;
    const monthsToSave = yearsToSave * 12;
    const r = annualReturn / 100 / 12;

    let futureAmount = 0;
    if (r > 0) {
      futureAmount = monthlySaving * ((Math.pow(1 + r, monthsToSave) - 1) / r) * (1 + r);
    } else {
      futureAmount = monthlySaving * monthsToSave;
    }

    const retirementYears = lifeExpect - retireAge;
    const totalNeeded = retirementYears * 12 * monthlyExpense;

    let grade = "C";
    const ratio = futureAmount / totalNeeded;
    if (ratio >= 1.2) grade = "A";
    else if (ratio >= 0.8) grade = "B";

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
      📊 預估需準備金額：約 ${Math.round(totalNeeded).toLocaleString()} 元<br>
      💰 預估可準備金額：約 ${Math.round(futureAmount).toLocaleString()} 元<br>
      💡 評級：${grade} 級（${grade === "A" ? "非常充足" : grade === "B" ? "尚可，建議強化" : "不足，需加強準備"}）<br>
      📤 資料送出中...
    `;

    // ✅ 改為共用 Apps Script Web App 的網址
    fetch("https://script.google.com/macros/s/AKfycbxXzyOUR_COMMON_EXEC_URL/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "retire",
        name,
        phone,
        age,
        retireAge,
        lifeExpect,
        monthlySaving,
        annualReturn,
        monthlyExpense,
        futureNeeded: Math.round(totalNeeded),
        futureAmount: Math.round(futureAmount),
        grade
      })
    })
    .then(res => res.json())
    .then(res => {
      if (res.result === "success") {
        resultDiv.innerHTML += "<br>✅ 已成功儲存";
      } else {
        resultDiv.innerHTML += "<br>❌ 儲存失敗：" + res.message;
      }
    })
    .catch(err => {
      resultDiv.innerHTML += "<br>❌ 發生錯誤，請稍後再試。";
    });
  });
</script>
