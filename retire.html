<script>
  document.getElementById("retireForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const age = +document.getElementById("age").value;
    const retireAge = +document.getElementById("retireAge").value;
    const lifeExpect = +document.getElementById("lifeExpect").value;
    const monthlySaving = +document.getElementById("monthlySaving").value;
    const annualReturn = +document.getElementById("annualReturn").value;
    const monthlyExpense = +document.getElementById("monthlyExpense").value;

    const yearsToSave = retireAge - age;
    const monthsToSave = yearsToSave * 12;
    const r = annualReturn / 100 / 12;

    let futureAmount = 0;
    if (r > 0) {
      futureAmount = monthlySaving * ((Math.pow(1 + r, monthsToSave) - 1) / r) * (1 + r);
    } else {
      futureAmount = monthlySaving * monthsToSave;
    }

    const retirementYears = lifeExpect - retireAge;
    const totalNeeded = retirementYears * 12 * monthlyExpense;

    let grade = "C";
    const ratio = futureAmount / totalNeeded;
    if (ratio >= 1.2) grade = "A";
    else if (ratio >= 0.8) grade = "B";

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
      ğŸ“Š é ä¼°éœ€æº–å‚™é‡‘é¡ï¼šç´„ ${Math.round(totalNeeded).toLocaleString()} å…ƒ<br>
      ğŸ’° é ä¼°å¯æº–å‚™é‡‘é¡ï¼šç´„ ${Math.round(futureAmount).toLocaleString()} å…ƒ<br>
      ğŸ’¡ è©•ç´šï¼š${grade} ç´šï¼ˆ${grade === "A" ? "éå¸¸å……è¶³" : grade === "B" ? "å°šå¯ï¼Œå»ºè­°å¼·åŒ–" : "ä¸è¶³ï¼Œéœ€åŠ å¼·æº–å‚™"}ï¼‰<br>
      ğŸ“¤ è³‡æ–™é€å‡ºä¸­...
    `;

    // âœ… æ”¹ç‚ºå…±ç”¨ Apps Script Web App çš„ç¶²å€
    fetch("https://script.google.com/macros/s/AKfycbxXzyOUR_COMMON_EXEC_URL/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "retire",
        name,
        phone,
        age,
        retireAge,
        lifeExpect,
        monthlySaving,
        annualReturn,
        monthlyExpense,
        futureNeeded: Math.round(totalNeeded),
        futureAmount: Math.round(futureAmount),
        grade
      })
    })
    .then(res => res.json())
    .then(res => {
      if (res.result === "success") {
        resultDiv.innerHTML += "<br>âœ… å·²æˆåŠŸå„²å­˜";
      } else {
        resultDiv.innerHTML += "<br>âŒ å„²å­˜å¤±æ•—ï¼š" + res.message;
      }
    })
    .catch(err => {
      resultDiv.innerHTML += "<br>âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    });
  });
</script>
